[TOC]

### ArrayList

#### åŸºç¡€

##### 1.æ‚è®°

- **å­˜å‚¨**: ArrayList å†…éƒ¨ä½¿ç”¨**åŠ¨æ€æ•°ç»„**å®ç°å…ƒç´ å­˜å‚¨. å…è®¸æ’å…¥æ‰€æœ‰å…ƒç´ , åŒ…æ‹¬ **null**, å…ƒç´ **å¯é‡å¤**. 
- **å¢**: æ¯æ¬¡**æ·»åŠ å…ƒç´ **æ—¶éƒ½ä¼šæ£€æŸ¥å…ƒç´ æ•°ç»„å®¹é‡æ˜¯å¦è¶³å¤Ÿ, å¯èƒ½ä¼šé¢ä¸´æ•°ç»„**æ‰©å®¹**ä¸å†…å®¹**å¤åˆ¶**ç­‰å¼€é”€é—®é¢˜. 
- **åˆ æ”¹æŸ¥**: æŒ‡å®šä½ç½®çš„æ’å…¥ä¸åˆ é™¤å…ƒç´ æ•ˆç‡ä½, å› ä¸ºéœ€è¦**ç§»åŠ¨å…¶å®ƒ**å…ƒç´ . å®ç°äº† RandomAccess æ¥å£, å¯å®ç°**å¿«é€Ÿéšæœº**è®¿é—®, æŒ‰ç…§**ç´¢å¼•**è¿›è¡Œè®¿é—®çš„æ•ˆç‡å¾ˆé«˜, æ•ˆç‡ä¸º O(1). æŒ‰ç…§å†…å®¹**æŸ¥æ‰¾**å…ƒç´ æ•ˆç‡**è¾ƒä½**, æ•ˆç‡ä¸º O(N). 
- **è¿­ä»£**: ArrayList çš„**è¿­ä»£å™¨**ä¼šè¿”å›ä¸€ä¸ª**å†…éƒ¨ç±» Itr å¯¹è±¡**, **è¿­ä»£æ—¶åˆ é™¤å…ƒç´ **åº”è¯¥ä½¿ç”¨**è¿­ä»£å™¨çš„ remove()** æ–¹æ³•è€Œé ArrayList æœ¬èº«çš„ remove() æ–¹æ³•, å¦åˆ™ä¼šäº§ç”Ÿ **Fail Fast** å¼‚å¸¸. å½“ç„¶ä¸€èˆ¬ä½¿ç”¨ä¸€æ¬¡ ArrayList çš„ remove() æ–¹æ³•æ˜¯æ²¡é—®é¢˜çš„. 
- **modCount** å±æ€§ç»§æ‰¿è‡ª **AbstractList**, ç”¨æ¥è®°å½•**ç»“æ„å‘ç”Ÿå˜åŒ–çš„æ¬¡æ•°**. è¿­ä»£æˆ–åºåˆ—åŒ–æ“ä½œä¼šæ£€æŸ¥ modCount ç‰ˆæœ¬, å¦‚æœä¸ä¸€è‡´åˆ™ä¼šäº§ç”Ÿ **Fail Fast å¼‚å¸¸**. 
- **å®‰å…¨æ€§**: ArrayList æ˜¯çº¿ç¨‹**ä¸å®‰å…¨**çš„, å¯ä»¥ä½¿ç”¨ **CopyOnWriteArrayList** æ¥è§£å†³å¹¶å‘å®‰å…¨é—®é¢˜. 

##### 2.åŸºæœ¬æ–¹æ³•

ArrayList åªèƒ½å­˜å‚¨**å¼•ç”¨ç±»å‹**è€Œ**ä¸èƒ½å­˜å‚¨åŸºæœ¬ç±»å‹**(éœ€ä½¿ç”¨å¯¹åº”çš„åŒ…è£…ç±»), å¦‚\<Integer>. 

```java
public boolean add(E obj); 				// å°†å…ƒç´ æ·»åŠ åˆ°é›†åˆå°¾éƒ¨
public boolean add(int index, E obj); 	// åœ¨æŒ‡å®šä½ç½®æ’å…¥å…ƒç´ , åé¢çš„å…ƒç´ å¾€åç§»åŠ¨
public E remove(int index); 			// åˆ é™¤æŒ‡å®šä½ç½®çš„å…ƒç´ , è¿”å›è¢«åˆ é™¤çš„å…ƒç´ 
public E get(int index);    			// è¿”å›æŒ‡å®šä½ç½®çš„å…ƒç´ 
public int size();  					// è¿”å›é›†åˆä¸­å…ƒç´ æ•°
// å°†åˆ—è¡¨çš„å­˜å‚¨å®¹é‡å‰Šå‡åˆ°å½“å‰æŒæœ‰å…ƒç´ å°ºå¯¸, ç¡®ä¿æ•°ç»„ä¸ä¼šæœ‰æ–°å…ƒç´ æ·»åŠ çš„æ—¶å€™è°ƒç”¨
public void trimToSize();  	
public void set(int index, E obj);		// è®¾ç½®æ•°ç»„åˆ—è¡¨æŒ‡å®šä½ç½®çš„å€¼, è¦†ç›–åŸæœ‰å†…å®¹
```

##### 3.çº¿ç¨‹å®‰å…¨

ArrayList ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„. å…¶åº•å±‚ä»¥åŠ¨æ€æ•°ç»„å­˜å‚¨, å¦‚æœå¤šçº¿ç¨‹åŒæ—¶æ“ä½œä¸€ä¸ª List é›†åˆ, æ¯”å¦‚åŒæ—¶å¢åŠ , åˆ é™¤å…ƒç´ å¯èƒ½ä¼šå‡ºç°é—®é¢˜, å¦‚æ•°ç»„ä¸‹æ ‡è¶Šç•Œå¼‚å¸¸. æ¨èå¤šçº¿ç¨‹åœºæ™¯ä½¿ç”¨ JUC ä¸­çš„ **CopyOnWriteArrayList**. 

#### ArrayListæºç åˆ†æ

ä¸‹é¢çš„åˆ†æåŸºäº **JDK8**. æœ€æ–°çš„ ArrayList æºç æœ‰æ”¹åŠ¨. 

##### 1.åŸºæœ¬å±æ€§

```java
public class ArrayList<E> extends AbstractList<E>
        implements List<E>, RandomAccess, Cloneable, java.io.Serializable {
    // é»˜è®¤å®¹é‡
    private static final int DEFAULT_CAPACITY = 10;
    // å­˜æ”¾å…ƒç´ æ•°ç»„
    transient Object[] elementData;
    // å®é™…å…ƒç´ ä¸ªæ•°, é»˜è®¤ä¸º0
    private int size;
    
    // ...
}
```

ArrayList ä½¿ç”¨**åŠ¨æ€æ•°ç»„ elementData å®ç°å…ƒç´ å­˜å‚¨**. åŒæ—¶ä¹Ÿå®ç°äº† RandomAccess æ¥å£, æ‰€ä»¥æ”¯æŒ**å¿«é€Ÿéšæœºè®¿é—®**. 

<img src="assets/image-20220530211849991.png" alt="image-20220530211849991" style="zoom:33%;" />

##### 2.æ„é€ æ–¹æ³•

ä¸»è¦æ˜¯åˆå§‹åŒ–ä¸€ä¸ªæŒ‡å®šå¤§å°çš„**æ•°ç»„**. 

```java
// åˆå§‹åŒ–å®¹é‡ä¸ºinitialCapacityçš„æ„é€ æ–¹æ³•
public ArrayList(int initialCapacity) {
   
    if (initialCapacity > 0) {
        // åˆå§‹åŒ–åŠ¨æ€æ•°ç»„elementData
        this.elementData = new Object[initialCapacity];
    } else if (initialCapacity == 0) {
        // å°†é»˜è®¤ç©ºæ•°ç»„èµ‹ç»™elementData
        this.elementData = EMPTY_ELEMENTDATA;
    } else { 
        throw new IllegalArgumentException("Illegal Capacity: " + initialCapacity);
    }
}
```

##### 3.åŸºæœ¬æ–¹æ³•

ä¸‹é¢æ˜¯ä¸€äº›åŸºç¡€æ–¹æ³•. 

```java
public int size() {
    return size;
}
public boolean isEmpty() {
    return size == 0;
}
public boolean contains(Object o) {
    return indexOf(o) >= 0;
}
```

##### 4.æ·»åŠ å…ƒç´ ä¸æ‰©å®¹

æ·»åŠ å…ƒç´ çš„ add() æ–¹æ³•å¦‚ä¸‹. **é»˜è®¤**æ·»åŠ åˆ°æ•°ç»„**æœ«å°¾**. 

```java
public boolean add(E e) {
    // ç¡®ä¿å®¹é‡è¶³å¤Ÿ(å®¹é‡ä¸è¶³æ—¶æ‰©å®¹)
    ensureCapacityInternal(size + 1);  // Increments modCount!!
    // å½“å‰å…ƒç´ æ’å…¥æ•°ç»„æœ«å°¾
    elementData[size++] = e;
    return true;
}
```

æ·»åŠ å…ƒç´ æ—¶ä½¿ç”¨ **ensureCapacityInternal() æ–¹æ³•**æ¥ä¿è¯æ•°ç»„å®¹é‡**è¶³å¤Ÿ**. å¦‚æœåˆå§‹åŒ–æ—¶**æ²¡æœ‰æŒ‡å®š**æ•°ç»„å¤§å°, é‚£ä¹ˆ**ç¬¬ä¸€æ¬¡**æ·»åŠ å…ƒç´ æ—¶**ä¼šæ‰©å®¹**, è¿™æ—¶å€™å°±ä¼š**æ‰©å®¹åˆ°é»˜è®¤çš„å®¹é‡10**; å¦‚æœæŒ‡å®šäº†å®¹é‡, é‚£å°±æŒ‰å®¹é‡ **1.5** å€æ‰©å®¹. 

```java
// ç¡®ä¿å®¹é‡è¶³å¤Ÿ
private void ensureCapacityInternal(int minCapacity) {  
    ensureExplicitCapacity(calculateCapacity(elementData, minCapacity));
}

// é¦–å…ˆè®¡ç®—capacity
private static int calculateCapacity(Object[] elementData, int minCapacity) {
    
    if (elementData == DEFAULTCAPACITY_EMPTY_ELEMENTDATA) {
        // å¦‚æœä¹‹å‰ä¸ºç©ºåˆ™æ‰©å®¹åˆ°é»˜è®¤å®¹é‡DEFAULT_CAPACITY = 10
        return Math.max(DEFAULT_CAPACITY, minCapacity);
    }
    // minCapacityæ˜¯å½“å‰æ‰€éœ€çš„æœ€å°å®¹é‡
    return minCapacity;
}

private void ensureExplicitCapacity(int minCapacity) {
    // å¢åŠ ç»“æ„ä¿®æ”¹è®¡æ•°å™¨
    modCount++;
    // å¦‚æœæœ€å°éœ€è¦ç©ºé—´æ¯”å½“å‰elementDataçš„å†…å­˜ç©ºé—´è¦å¤§, åˆ™éœ€è¦æ‰©å®¹
    if (minCapacity - elementData.length > 0)
        grow(minCapacity);
}
```

å¦‚æœå®¹é‡ä¸å¤Ÿæ—¶, éœ€è¦ä½¿ç”¨ **grow() æ–¹æ³•è¿›è¡Œæ‰©å®¹**, æ–°å®¹é‡çš„å¤§å°ä¸º **oldCapacity + (oldCapacity >> 1)**, ä¹Ÿå°±æ˜¯æ—§å®¹é‡çš„ **1.5 å€**. elementData æ•°ç»„ä¼šéšç€å®é™…å…ƒç´ ä¸ªæ•°çš„å¢å¤šè€Œé‡æ–°åˆ†é…. 

```java
// è¿›è¡Œæ•°ç»„æ‰©å®¹
private void grow(int minCapacity) {
    // åŸå§‹æ•°ç»„é•¿åº¦
    int oldCapacity = elementData.length;
    // æ‰©å®¹è‡³åŸæ¥çš„1.5å€
    int newCapacity = oldCapacity + (oldCapacity >> 1);
    // å†åˆ¤æ–­ä¸€ä¸‹æ–°æ•°ç»„å®¹é‡å¤Ÿä¸å¤Ÿ, å¤Ÿäº†å°±ç›´æ¥ä½¿ç”¨è¿™ä¸ªé•¿åº¦åˆ›å»ºæ–°æ•°ç»„, ä¸å¤Ÿå°±å°†æ•°ç»„é•¿åº¦è®¾ç½®ä¸ºéœ€è¦çš„é•¿åº¦
    if (newCapacity - minCapacity < 0)
        newCapacity = minCapacity;
    // è‹¥é¢„è®¾å€¼å¤§äºé»˜è®¤çš„æœ€å¤§å€¼æ£€æŸ¥æ˜¯å¦æº¢å‡º
    if (newCapacity - MAX_ARRAY_SIZE > 0)
        newCapacity = hugeCapacity(minCapacity);
    // è°ƒç”¨Arrays.copyOf()æ–¹æ³•è¿›è¡Œæ•°æ®æ‹·è´
    elementData = Arrays.copyOf(elementData, newCapacity);
}
```

**æ‰©å®¹æ“ä½œ**éœ€è¦è°ƒç”¨ Arrays.copyOf() æŠŠåŸæ•°ç»„æ•´ä¸ª**å¤åˆ¶**åˆ°æ–°æ•°ç»„ä¸­, è¿™ä¸ªæ“ä½œ**ä»£ä»·å¾ˆé«˜**, å› æ­¤ä¸€å®šè¦åœ¨åˆå§‹åŒ– ArrayList å¯¹è±¡æ—¶å°±**æŒ‡å®š**å¤§æ¦‚çš„å®¹é‡å¤§å°, **å‡å°‘æ‰©å®¹æ“ä½œçš„æ¬¡æ•°**, å‡å°‘å¯¹æ€§èƒ½çš„å½±å“. æœ€å¥½æ ¹æ®ä¸šåŠ¡åœºæ™¯**æŒ‡å®šåˆå§‹åŒ–å®¹é‡**é˜²æ­¢è¿‡å¤šçš„æ‰©å®¹ä¸å¤åˆ¶å¼€é”€(é˜¿é‡Œè§„èŒƒ). 

add() æ–¹æ³•ä¹Ÿå¯ä»¥åœ¨**æŒ‡å®šç´¢å¼•**å¤„æ·»åŠ å…ƒç´ . è¿™é‡Œéœ€è¦å°† index ä½ç½®åŠä»¥åçš„å…ƒç´ æ¬è¿åˆ° index + 1 ä¹‹å, å¼€é”€ä¹Ÿå¤§. 

```java
public void add(int index, E element) {
    // åˆ¤æ–­indexæ˜¯å¦è¶Šç•Œ
    rangeCheckForAdd(index);
    // æ‰©å®¹
    ensureCapacityInternal(size + 1);  // Increments modCount!!
    // public static void arraycopy(Object src, int srcPos, Object dest, int destPos, int length)
    // src:æºæ•°ç»„; srcPos:æºæ•°ç»„è¦å¤åˆ¶çš„èµ·å§‹ä½ç½®; dest:ç›®çš„æ•°ç»„; destPos:ç›®çš„æ•°ç»„æ”¾ç½®çš„èµ·å§‹ä½ç½®; length:å¤åˆ¶çš„é•¿åº¦
    // å°†elementDataä»indexä½ç½®å¼€å§‹, å¤åˆ¶åˆ°elementDataçš„index+1å¼€å§‹çš„è¿ç»­ç©ºé—´
    System.arraycopy(elementData, index, elementData, index + 1, size - index);
    // åœ¨elementDataçš„indexä½ç½®èµ‹å€¼element
    elementData[index] = element;
    size++;
}
```

##### 5.è·å–å…ƒç´ 

è·å–å…ƒç´ ç”¨ **get()** æ–¹æ³•. å³ç›´æ¥é€šè¿‡**ç´¢å¼•**è·å–å¯¹åº”ä½ç½®çš„å…ƒç´ , é€Ÿåº¦å¿«. 

```java
public E get(int index) {
    // æ£€æŸ¥ç´¢å¼•æ˜¯å¦è¶Šç•Œ
    rangeCheck(index);
	// è¿”å›æ•°æ®æ•°ç»„æŒ‡å®šç´¢å¼•ä½ç½®çš„å…ƒç´ 
    return elementData(index);
}

E elementData(int index) {
    return (E) elementData[index];
}
```

indexOf() ç”¨äºè¿”å›ä¸€ä¸ªå€¼åœ¨æ•°ç»„**é¦–æ¬¡å‡ºç°çš„ä½ç½®**, ä¼šæ ¹æ®æ˜¯å¦ä¸º null ä½¿ç”¨ä¸åŒæ–¹å¼åˆ¤æ–­. ä¸å­˜åœ¨å°±è¿”å› -1. æ—¶é—´å¤æ‚åº¦ä¸ºO(N). 

```java
public int indexOf(Object o) {
    if (o == null) {
        for (int i = 0; i < size; i++)
            if (elementData[i] == null)
                return i;
    } else {
        for (int i = 0; i < size; i++)
            if (o.equals(elementData[i]))
                return i;
    }
    return -1;
}
```

lastIndexOf() æ–¹æ³•æ•ˆæœç±»ä¼¼, åªæ˜¯åè¿‡æ¥ä»åé¢å¼€å§‹æ‰¾ç´¢å¼•ä½ç½®. 

##### 6.æ›´æ–°å…ƒç´ 

æ›´æ–°å…ƒç´ ä¾ç„¶æ˜¯é€šè¿‡**ç´¢å¼•**æ¥çš„. æ›´æ–°ä¹‹åä¼šè¿”å›åŸå§‹ç´¢å¼•å¤„çš„æ—§å…ƒç´ . 

```java
public E set(int index, E element) {
    rangeCheck(index);	// ç´¢å¼•æœ‰æ•ˆæ€§æ£€æŸ¥
	// è·å–æ—§å…ƒç´ 
    E oldValue = elementData(index);
    // è®¾ç½®æ–°å…ƒç´ 
    elementData[index] = element;
    // è¿”å›æ—§å…ƒç´ 
    return oldValue;
}
```

##### 7.åºåˆ—åŒ–

ArrayList åŸºäº**æ•°ç»„**å®ç°, å¹¶ä¸”å…·æœ‰**åŠ¨æ€æ‰©å®¹**ç‰¹æ€§, å› æ­¤ä¿å­˜å…ƒç´ çš„æ•°ç»„**ä¸ä¸€å®šéƒ½ä¼šè¢«ä½¿ç”¨**, é‚£ä¹ˆ**å°±æ²¡å¿…è¦å…¨éƒ¨**è¿›è¡Œåºåˆ—åŒ–. æ‰€ä»¥ä¿å­˜å…ƒç´ çš„æ•°ç»„ **elementData** ä½¿ç”¨ **transient** ä¿®é¥°, è¯¥å…³é”®å­—å£°æ˜æ•°ç»„é»˜è®¤**ä¸ä¼šè¢«åºåˆ—åŒ–**. 

```java
transient Object[] elementData; // non-private to simplify nested class access
```

å› æ­¤ ArrayList è‡ªå®šä¹‰äº†åºåˆ—åŒ–ä¸ååºåˆ—åŒ–æ–¹æ³•ä¿è¯åªå¯¹æ•°ç»„ä¸­çš„**æœ‰æ•ˆå…ƒç´ **è¿›è¡Œåºåˆ—åŒ–. ArrayList å®ç°äº† **writeObject()** å’Œ **readObject()** æ¥æ§åˆ¶==**åªåºåˆ—åŒ–æ•°ç»„ä¸­æœ‰å…ƒç´ å¡«å……é‚£éƒ¨åˆ†**==å†…å®¹, æ•°ç»„æ²¡æœ‰å­˜å…ƒç´ çš„éƒ¨åˆ†**ä¸**åºåˆ—åŒ–. å½“å†™å…¥åˆ°è¾“å‡ºæµæ—¶, å…ˆå†™å…¥å®¹é‡, å†ä¾æ¬¡å†™å…¥æ¯ä¸€ä¸ªå…ƒç´ ; å½“è¯»å‡ºè¾“å…¥æµæ—¶, å…ˆè¯»å–å®¹é‡, å†ä¾æ¬¡è¯»å–æ¯ä¸€ä¸ªå…ƒç´ . 

æ³¨æ„: åºåˆ—åŒ–æ—¶ä¹Ÿä¼š**æ£€æŸ¥ modCount**, å¦‚æœåºåˆ—åŒ–æ—¶å¹¶å‘**ä¿®æ”¹**åˆ—è¡¨, å¯èƒ½é€ æˆ Fail Fast å¼‚å¸¸. 

åºåˆ—åŒ–æ–¹æ³•å¦‚ä¸‹:

```java
private void writeObject(java.io.ObjectOutputStream s) throws java.io.IOException {
    // ç¼“å­˜modCount
    int expectedModCount = modCount;
    // æ‰§è¡Œé»˜è®¤çš„ååºåˆ—åŒ–/åºåˆ—åŒ–è¿‡ç¨‹. å°†å½“å‰ç±»çš„éé™æ€å’Œéç¬æ€å­—æ®µå†™å…¥æ­¤æµ
    s.defaultWriteObject();
    // å†™å…¥å¤§å°
    s.writeInt(size);
    // æŒ‰é¡ºåºå†™å…¥æ‰€æœ‰å…ƒç´ 
    for (int i = 0; i < size; i++) {
        s.writeObject(elementData[i]);
    }
    // å†™å…¥è¿‡ç¨‹æ•°ç»„è¢«æ›´æ”¹ä¼šæŠ›å‡ºå¼‚å¸¸
    if (modCount != expectedModCount) {
        throw new ConcurrentModificationException();
    }
}
```

ååºåˆ—åŒ–æ–¹æ³•å¦‚ä¸‹:

```java
private void readObject(java.io.ObjectInputStream s) throws java.io.IOException, ClassNotFoundException {
    elementData = EMPTY_ELEMENTDATA;
    // æ‰§è¡Œé»˜è®¤çš„åºåˆ—åŒ–/ååºåˆ—åŒ–è¿‡ç¨‹
    s.defaultReadObject();
    // è¯»å…¥æ•°ç»„é•¿åº¦
    s.readInt(); 
    if (size > 0) {
        // åƒclone()æ–¹æ³•, ä½†æ ¹æ®å¤§å°è€Œä¸æ˜¯å®¹é‡åˆ†é…æ•°ç»„
        int capacity = calculateCapacity(elementData, size);
        SharedSecrets.getJavaOISAccess().checkArray(s, Object[].class, capacity);
        ensureCapacityInternal(size);
        Object[] a = elementData;
        // è¯»å…¥æ‰€æœ‰å…ƒç´ 
        for (int i = 0; i < size; i++) {
            a[i] = s.readObject();
        }
    }
}
```

**åºåˆ—åŒ–**æ—¶éœ€è¦ä½¿ç”¨ ObjectOutputStream çš„ writeObject() å°†å¯¹è±¡è½¬æ¢ä¸º**å­—èŠ‚æµ**å¹¶è¾“å‡º. è€Œ writeObject() æ–¹æ³•åœ¨ä¼ å…¥çš„å¯¹è±¡**å­˜åœ¨ writeObject()** çš„æ—¶å€™ä¼šå»**åå°„**è°ƒç”¨è¯¥å¯¹è±¡çš„ writeObject() æ¥å®ç°**åºåˆ—åŒ–**. ååºåˆ—åŒ–ä½¿ç”¨çš„æ˜¯ ObjectInputStream çš„ readObject() æ–¹æ³•, åŸç†ç±»ä¼¼. 

```java
ArrayList list = new ArrayList();
ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(file));
oos.writeObject(list);
```

##### 8.åˆ é™¤å…ƒç´ 

åˆ é™¤å…ƒç´ æ—¶è°ƒç”¨ **System.arraycopy()** å°† index + 1 **åé¢**çš„å…ƒç´ éƒ½**å¤åˆ¶**åˆ° index ä½ç½®ä¸Š, è¯¥æ“ä½œçš„æ—¶é—´å¤æ‚åº¦ä¸º **O(N)**, å¼€é”€è¾ƒé«˜. 

æ³¨æ„: **remove() æ“ä½œä¼šä¿®æ”¹ modCount å€¼**. 

```java
public E remove(int index) {
    // åˆ¤æ–­æ˜¯å¦è¶Šç•Œ
    rangeCheck(index);
    
    // ä¿®æ”¹modCountå€¼
    modCount++;
    // è¯»å–æ—§å€¼
    E oldValue = elementData(index);
    // è·å–indexä½ç½®å¼€å§‹åˆ°æœ€åä¸€ä¸ªä½ç½®çš„ä¸ªæ•°
    int numMoved = size - index - 1;
    if (numMoved > 0)
        // å°†elementDataæ•°ç»„index+1ä½ç½®å¼€å§‹æ‹·è´åˆ°elementDataä»indexå¼€å§‹çš„ç©ºé—´
        System.arraycopy(elementData, index + 1, elementData, index, numMoved);
    // æ¸…ç†ç©ºé—´,ä¾¿äºåƒåœ¾å›æ”¶å™¨å›æ”¶
    elementData[--size] = null; 
    return oldValue;
}
```

##### 9.è¿­ä»£åˆ é™¤

**è¿­ä»£å™¨**çš„å¸¸è§**è¯¯ç”¨**å°±æ˜¯åœ¨è¿­ä»£**è¿‡ç¨‹ä¸­**è°ƒç”¨**å®¹å™¨çš„åˆ é™¤æ–¹æ³•**. 

```java
List<String> list = new ArrayList<>();
list.add("str1");
list.add("str1");
list.add("str1");
for (String s : list) {
    if ("str1".equals(s)) {
        // è¿™é‡Œä½¿ç”¨Listæ¥å£æä¾›çš„remove()æ–¹æ³•
        list.remove(s);
    }
}
```

è¿™çœ‹èµ·æ¥æ²¡æœ‰ä»€ä¹ˆé—®é¢˜, ä½†æ˜¯è¿è¡Œå°±ä¼šæŠ›å‡º **ConcurrentModificationException** å¼‚å¸¸. æ¯å½“ä½¿ç”¨**è¿­ä»£å™¨éå†å…ƒç´ **æ—¶, å¦‚æœ**ä¿®æ”¹äº†åˆ—è¡¨**(**æ·»åŠ ã€åˆ é™¤**å…ƒç´ ), å°±ä¼š**æŠ›å‡ºå¼‚å¸¸**, ç”±äº **foreach** åŒæ ·ä½¿ç”¨çš„æ˜¯**è¿­ä»£å™¨**, æ‰€ä»¥ä¹Ÿä¸€æ ·. 

è·å–**è¿­ä»£å™¨**çš„æºç ä¸­è¿”å›çš„æ˜¯ä¸€ä¸ª**å†…éƒ¨ç±» Itr** å¯¹è±¡. 

```java
public Iterator<E> iterator() {
    return new Itr();
}
```

å¦‚æœä¸Šé¢çš„ä»£ç æ”¹æˆä¸‹é¢è¿™æ ·å°±ä¸ä¼šæŠ›å¼‚å¸¸äº†. 

```java
List<String> list = new ArrayList<>();
list.add("str1");
list.add("str1");
list.add("str1");

Iterator iterator = list.iterator();
while (iterator.hasNext()) {
    if ("str1".equals(iterator.next())) {
        // è¿™é‡Œä½¿ç”¨äº†è¿­ä»£å™¨è¿”å›çš„remove()æ–¹æ³•è€Œä¸æ˜¯listå®ç°çš„remove()æ–¹æ³•
        iterator.remove();
    }
}
```

è¿™ä¸ªå†…éƒ¨ç±» Itr æºç å¦‚ä¸‹: 

```java
private class Itr implements Iterator<E> {
    int cursor;       // æ¸¸æ ‡, ä¸‹ä¸€ä¸ªå…ƒç´ çš„ç´¢å¼•, é»˜è®¤åˆå§‹åŒ–ä¸º0
    int lastRet = -1; // ä¸Šæ¬¡è®¿é—®å…ƒç´ çš„ä½ç½®
    
    // !!!è®°å½•ç”Ÿæˆè¿­ä»£å™¨æ—¶çš„modCountå€¼,å¦‚æœè¿­ä»£æ—¶modCountå˜åŒ–åˆ™æŠ›å‡ºå¼‚å¸¸
    int expectedModCount = modCount;
    
    public boolean hasNext() {
        return cursor != size;
    }

    @SuppressWarnings("unchecked")
    public E next() {
        // æ£€æŸ¥æ•°ç»„æ˜¯å¦è¢«ä¿®æ”¹
        checkForComodification();
        int i = cursor;
        if (i >= size)
            throw new NoSuchElementException();
        Object[] elementData = ArrayList.this.elementData;
        if (i >= elementData.length)
            throw new ConcurrentModificationException();
        cursor = i + 1;// å‘åç§»åŠ¨æ¸¸æ ‡
        return (E) elementData[lastRet = i];
    }

    // åˆ é™¤å…ƒç´ 
    public void remove() {
        if (lastRet < 0)
            throw new IllegalStateException();
        checkForComodification(); // æ£€æŸ¥æ•°ç»„æ˜¯å¦è¢«ä¿®æ”¹
		// ç”¨è¿­ä»£å™¨çš„åˆ é™¤æ–¹æ³•ä¼šè‡ªå·±æ›´æ–°modCountå€¼
        try {
            // è¿™é‡Œè°ƒç”¨ArrayListè‡ªèº«çš„remove()æ–¹æ³•, è¯¥æ–¹æ³•ä¼šä¿®æ”¹modCountå€¼
            ArrayList.this.remove(lastRet);
            cursor = lastRet;
            lastRet = -1;
            // ä¿®æ”¹è¿­ä»£å™¨å†…éƒ¨çš„expectedModCountä¸ºåˆ é™¤åå½“å‰æœ€æ–°çš„modCountå€¼, è¿™æ ·ä¸¤ä¸ªå€¼ä¸€è‡´å°±ä¸ä¼šæŠ›å¼‚å¸¸
            expectedModCount = modCount;
        } catch (IndexOutOfBoundsException ex) {
            throw new ConcurrentModificationException();
        }
    }

    // æ£€æŸ¥æ•°ç»„æ˜¯å¦è¢«ä¿®æ”¹: å³åˆ¤æ–­å½“å‰åˆ—è¡¨çš„modCountå€¼ä¸ç”Ÿæˆè¿­ä»£å™¨æ—¶çš„modCountæ˜¯å¦ä¸€è‡´
    final void checkForComodification() {
        if (modCount != expectedModCount)
            throw new ConcurrentModificationException();
    }
    
    // ...
}
```

å¯ä»¥çœ‹åˆ°å…±æœ‰**ä¸¤ä¸ª remove()** æ–¹æ³•, ä¸€ä¸ªå±äº ArrayList **æœ¬èº«**, è¿˜æœ‰ä¸€ä¸ªå±äºå…¶**å†…éƒ¨ç±» Itr**. 

ArrayList ä¸­æœ‰ä¸€ä¸ª **modCount** å±æ€§, è¯¥å±æ€§æ˜¯ç»§æ‰¿è‡ª **AbstractList**, ç”¨äºè®°å½•å¯¹ ArrayList è¿›è¡Œ**ç»“æ„æ€§æ“ä½œçš„æ¬¡æ•°**, å½“**æ·»åŠ æˆ–è€…åˆ é™¤**å…ƒç´ æ—¶, modeCount å€¼å°±ä¼šè¿›è¡Œå¯¹åº”æ¬¡æ•°çš„**å¢åŠ **. ç›¸å½“äºè®°å½•äº†**ç»“æ„æ€§å˜åŒ–**, å³**æ·»åŠ , åˆ é™¤**å…ƒç´ , åªæ˜¯**ä¿®æ”¹**å…ƒç´ çš„å†…å®¹**ä¸ç®—**ç»“æ„æ€§å˜åŒ–. 

ä½¿ç”¨ ArrayList çš„ **iterator()** æ–¹æ³•è·å–åˆ°**è¿­ä»£å™¨**è¿›è¡Œéå†æ—¶, ä¼šæŠŠ ArrayList **å½“å‰çŠ¶æ€ä¸‹çš„ modCount èµ‹å€¼ç»™ Itr ç±»çš„ expectedModCount** å±æ€§, ç›¸å½“äºåœ¨åˆ›å»ºè¿­ä»£å™¨æ—¶å¯¹å¤–éƒ¨çš„ modCount è®°å½•äº†ä¸€ä¸ª**ç‰ˆæœ¬å¿«ç…§**. å¦‚æœåœ¨è¿­ä»£è¿‡ç¨‹ä¸­ä½¿ç”¨äº† ArrayList çš„ **remove()** æˆ– **add()** æ–¹æ³•, å®ƒä»¬ä¼šä¿®æ”¹å¤–éƒ¨çš„ modCount å€¼è¿›è¡ŒåŠ  1, ä½†è¿­ä»£å™¨ä¸­çš„ **expectedModeCount** å¹¶æ²¡æœ‰å˜åŒ–, å½“ä½¿ç”¨è¿­ä»£å™¨çš„ next() æ–¹æ³•æ—¶, å®ƒä¼šè°ƒç”¨ **checkForComodification()** æ–¹æ³•, é€šè¿‡å¯¹æ¯”å‘ç°å½“å‰çš„ expectedModCount å·²ç»ä¸å¤–éƒ¨çš„ modCount å€¼**ä¸ä¸€è‡´**äº†, åˆ™ä¼šæŠ›å‡ºConcurrentModificationException å¼‚å¸¸. 

ä½†æ˜¯å¦‚æœä½¿ç”¨å†…éƒ¨ç±» **Itr è¿­ä»£å™¨æä¾›çš„ remove() æ–¹æ³•**, å®ƒä¼šè°ƒç”¨ ArrayList æä¾›çš„ remove() æ–¹æ³•å, è¿˜ä¼šä½¿ **==expectedModCount = modCount==**, è¿™ä½¿å¾—å½“å‰è¿­ä»£å™¨å†…éƒ¨è®°å½•çš„ expectedModCount çš„å€¼ä¸å¤–éƒ¨ä¸€è‡´, æ‰€ä»¥å°±ä¸ä¼šå­˜åœ¨ç‰ˆæœ¬ä¸ä¸€è‡´é—®é¢˜, ä¹Ÿå°±ä¸ä¼šæŠ›å‡ºå¼‚å¸¸. 

ç»¼ä¸Š: **åœ¨å•çº¿ç¨‹çš„éå†è¿‡ç¨‹ä¸­, å¦‚æœè¦è¿›è¡Œ remove æ“ä½œ, åº”è¯¥è°ƒç”¨è¿­ä»£å™¨çš„ remove() æ–¹æ³•è€Œä¸æ˜¯é›†åˆç±»çš„ remove() æ–¹æ³•**. 

PS: è¿™é‡Œè®¨è®ºçš„æ˜¯**==è¿­ä»£åˆ é™¤==æ—¶ä½¿ç”¨ ArrayList çš„ remove() æ–¹æ³•**, ä¸€èˆ¬ä½¿ç”¨ ArrayList çš„ remove() æ–¹æ³•æ˜¯æ²¡é—®é¢˜çš„. 

#### fail-fastæœºåˆ¶

##### 1.æ¦‚è¿°

ä¸Šé¢çš„ä¾‹å­å°±å¯ä»¥å¼•å‡º fail-fast æœºåˆ¶, å³**å¿«é€Ÿå¤±è´¥æœºåˆ¶**, æ˜¯ Java **é›†åˆ**(Collection)ä¸­çš„ä¸€ç§**é”™è¯¯æ£€æµ‹æœºåˆ¶**. å½“åœ¨==**åºåˆ—åŒ–æˆ–è€…è¿­ä»£**==é›†åˆçš„è¿‡ç¨‹ä¸­è¯¥é›†åˆåœ¨==**å‘ç”Ÿç»“æ„æ€§å˜åŒ–**==çš„æ—¶å€™, å°±æœ‰å¯èƒ½ä¼šå‘ç”Ÿ fail-fast, å³æŠ›å‡º **ConcurrentModificationException** å¼‚å¸¸. 

fail-fast æœºåˆ¶çš„å®ç°ä¾èµ–äº **modCount** å±æ€§, å¯ä»¥ç”¨äº**æ£€æŸ¥å¹¶å‘ä¿®æ”¹**çš„æƒ…å†µ. **modCount** æ­¤å­—æ®µç”± **iterator()** å’Œ **listiterator()** æ–¹æ³•è¿”å›çš„**è¿­ä»£å™¨å’Œåˆ—è¡¨è¿­ä»£å™¨**å®ç°ä½¿ç”¨. **å­ç±»**æ˜¯å¦ä½¿ç”¨æ­¤å­—æ®µæ˜¯**å¯é€‰**çš„. å¦‚æœ**å­ç±»**å¸Œæœ›æä¾›å¿«é€Ÿå¤±è´¥è¿­ä»£å™¨(å’Œåˆ—è¡¨è¿­ä»£å™¨), åˆ™å®ƒåªéœ€åœ¨å…¶ add(E e) å’Œ remove(int) æ–¹æ³•(ä»¥åŠå®ƒæ‰€è¦†å†™çš„, å¯¼è‡´åˆ—è¡¨ç»“æ„ä¸Šä¿®æ”¹çš„ä»»ä½•å…¶ä»–æ–¹æ³•)ä¸­å¢åŠ æ­¤å­—æ®µå³å¯. 

```java
protected transient int modCount = 0;
```

è®¸å¤šå¸¸è§çš„é›†åˆç±»éƒ½å¯èƒ½å‡ºç° fail-fast æœºåˆ¶, å¦‚ ArrayList, HashMap. å› ä¸ºå…¶å†…éƒ¨éƒ½æœ‰è¿™ä¸ªå±æ€§. 

fail-fast æœºåˆ¶å¹¶ä¸ä¿è¯åœ¨ä¸åŒæ­¥çš„ä¿®æ”¹ä¸‹ä¸€å®šä¼šæŠ›å‡ºå¼‚å¸¸, å®ƒåªæ˜¯å°½æœ€å¤§åŠªåŠ›å»æŠ›å‡º, æ‰€ä»¥è¿™ç§æœºåˆ¶ä¸€èˆ¬ä»…ç”¨äºæ£€æµ‹ bug. 

åœ¨**å¤šçº¿ç¨‹å’Œå•çº¿ç¨‹**ç¯å¢ƒä¸‹éƒ½æœ‰å¯èƒ½å‡ºç° fail-fast. 

fail-fast ä¼šåœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¸‹æŠ›å‡º ConcurrentModificationException: 

(1)**å•çº¿ç¨‹ç¯å¢ƒ**

- é›†åˆè¢«åˆ›å»ºå, åœ¨**éå†**å®ƒçš„è¿‡ç¨‹ä¸­**ä¿®æ”¹**äº†ç»“æ„. å¦‚è¿­ä»£æ—¶è°ƒç”¨äº† ArrayList è‡ªå·±çš„ remove() æ–¹æ³•. 

(2)**å¤šçº¿ç¨‹ç¯å¢ƒ**

- å½“ä¸€ä¸ªçº¿ç¨‹åœ¨**éå†**è¿™ä¸ªé›†åˆ, è€Œ**å¦ä¸€ä¸ªçº¿ç¨‹**å¯¹è¿™ä¸ªé›†åˆçš„ç»“æ„è¿›è¡Œäº†ä¿®æ”¹. 

##### 2.é¿å…fail-fast

**æ–¹æ³•1**: åœ¨**å•çº¿ç¨‹**éå†è¿‡ç¨‹ä¸­, å¦‚æœè¦è¿›è¡Œ remove æ“ä½œ, åº”è¯¥è°ƒç”¨**è¿­ä»£å™¨çš„ remove()** æ–¹æ³•. 

**æ–¹æ³•2**: ä½¿ç”¨ JUC ä¸­çš„ç±»æ¥ä»£æ›¿ ArrayList å’Œ HashMap. å¦‚ **CopyOnWriterArrayList** ä»£æ›¿ ArrayList. ä½¿ç”¨ **ConcurrentHashMap** æ›¿ä»£ HashMap. 

#### Arrays.asList()

Arrays ç±»çš„é™æ€æ–¹æ³• asList() å°†æ•°ç»„è½¬ä¸º**é›†åˆ**. 

```java
String[] str = new String[]{"1","2","3"};
List aslist = Arrays.asList(str);
aslsit.add("4");
// Exception in thread "main" java.lang.UnsupportedOperationException
//    at java.util.AbstractList.add(Unknown Source)
//    at java.util.AbstractList.add(Unknown Source)
//    at test.LinkedListTest.main(LinkedListTest.java:13)
```

å…¶å® asList() è¿”å›çš„æ˜¯ java.util.**Arrays.ArrayList** å¯¹è±¡, **å¹¶ä¸æ˜¯æ™®é€šçš„ ArrayList ç±»**! çœ‹ Arrays ç±»çš„éƒ¨åˆ†æºç : 

```java
public class Arrays {
    
    // çœç•¥
 
    public static <T> List<T> asList(T... a) {
        return new ArrayList<>(a);
    }
        
    // è¿™ä¸ªå†…éƒ¨ç±»å°±æ˜¯å®ƒ        ğŸ‘‡
    private static class ArrayList<E> extends AbstractList<E> 
   						implements RandomAccess, java.io.Serializable{
    
        private final E[] a;
    
        ArrayList(E[] array) {
            a = Objects.requireNonNull(array);
        }
    
        @Override
        public int size() {
            return a.length;
        }
        // çœç•¥å…¶ä»–æ–¹æ³•
    }
}
```

**Arrays ä¸­çš„ ArrayList** ç±»æ˜¯ Arrays çš„ä¸€ä¸ª**é™æ€å†…éƒ¨ç±»**, å®ƒ**æ²¡æœ‰å®Œå…¨**å®ç° List çš„æ–¹æ³•. Arrays.ArrayList æ˜¯ä¸€ä¸ª**å®šé•¿**é›†åˆ, å› ä¸ºå®ƒ**æ²¡æœ‰è¦†å†™** add(), remove() æ–¹æ³•, æ‰€ä»¥ä¸€æ—¦åˆå§‹åŒ–å…ƒç´ å, é›†åˆçš„ size å°±æ˜¯**ä¸å¯å˜**çš„. æ‰€ä»¥ä½¿ç”¨è¿™ç§æ”¹å˜ç»“æ„çš„æ–¹æ³•ä¼šæŠ› UnsupportedOperationException å¼‚å¸¸. 

### LinkedList

#### åŸºç¡€

LinkedList ä¹Ÿå®ç°äº† List æ¥å£, å†…éƒ¨åŸºäº**åŒå‘é“¾è¡¨**å®ç°, æ‰€ä»¥å…¶ç‰¹ç‚¹ä¸ ArrayList å‡ ä¹**ç›¸å**. 

LinkedList è¿˜å®ç°äº† **Deque** æ¥å£, å¯ä»¥æŒ‰ç…§**é˜Ÿåˆ—ã€æ ˆå’ŒåŒç«¯é˜Ÿåˆ—**çš„æ–¹å¼è¿›è¡Œæ“ä½œ. 

LinkedList ä¹Ÿæ˜¯çº¿ç¨‹**ä¸å®‰å…¨**çš„é˜Ÿåˆ—. 

##### 1.åŸºæœ¬æ–¹æ³•

**é¢è¯•**çš„æ—¶å€™å¯ä»¥ç”¨æ¥å®ç°**é˜Ÿåˆ—, æ ˆ**ç­‰ç»“æ„, éå¸¸æ–¹ä¾¿, è¦**è®°ç‰¢å‡ ä¸ª API**.

```java
int size();  	// è¿”å›å…ƒç´ æ•°é‡
void clear();  	// åˆ é™¤æ‰€æœ‰å…ƒç´ 
Object set(int index, Object element);  // ç”¨äºç”¨æ–°å…ƒç´ æ›¿æ¢é“¾è¡¨ä¸­çš„ç°æœ‰å…ƒç´ 
boolean contains(Object element);		// å¦‚æœå…ƒç´ å­˜åœ¨äºé“¾è¡¨ä¸­, åˆ™è¿”å›true
boolean add(Object element);			// å°†å…ƒç´ é™„åŠ åˆ°é“¾è¡¨çš„æœ«å°¾
void add(int index, Object element);	
boolean addAll(Collection C);			// å°†ä¸€ä¸ªé›†åˆè¿½åŠ åˆ°é“¾è¡¨
boolean addAll(int index, Collection C);
void addFirst(Object element);			// å°†å…ƒç´ æ’å…¥é“¾è¡¨çš„å¼€å¤´
void addLast(Object element);			// å°†å…ƒç´ é™„åŠ åœ¨é“¾è¡¨çš„æœ«å°¾
Object get(int index);	// è¿”å›é“¾è¡¨ä¸­ä½ç½®'index'å¤„çš„å…ƒç´ . 
Object getFirst();		// è¿”å›é“¾è¡¨ç¬¬ä¸€ä¸ªå…ƒç´ 
Object getLast();		// è¿”å›é“¾è¡¨æœ€åä¸€ä¸ªå…ƒç´ 
int indexOf(Object element);	// è¿”å›å…ƒç´ ç¬¬ä¸€æ¬¡å‡ºç°çš„ç´¢å¼•
int lastIndexOf(Object element);// è¿”å›å…ƒç´ æœ€åä¸€æ¬¡å‡ºç°çš„ç´¢å¼•
Object remove();		        // ä»é“¾è¡¨å¤´éƒ¨åˆ é™¤å¹¶è¿”å›å…ƒç´ 
Object remove(int index);		// åˆ é™¤æ­¤é“¾è¡¨ä¸­ä½ç½®'index'å¤„çš„å…ƒç´  
boolean remove(Object O);		// ä»é“¾è¡¨ä¸­ç§»é™¤ä¸€ä¸ªç‰¹å®šçš„å…ƒç´ 
Object removeLast();			// åˆ é™¤å¹¶è¿”å›é“¾è¡¨æœ€åä¸€ä¸ªå…ƒç´ 
```

#### æºç è§£æ

##### 1.å†…éƒ¨ç»“ç‚¹ç±»

åŸºäº**åŒå‘é“¾è¡¨**å®ç°, ä½¿ç”¨å†…éƒ¨èŠ‚ç‚¹ç±» **Node** å­˜å‚¨é“¾è¡¨èŠ‚ç‚¹ä¿¡æ¯, æ¯ä¸ªç»“ç‚¹å­˜å‚¨äº† next å’Œ prev æŒ‡é’ˆ.

```java
private static class Node<E> {
    E item;			// æ•°æ®
    Node<E> next;	// åç»§ç»“ç‚¹æŒ‡é’ˆ
    Node<E> prev;	// å‰é©±ç»“ç‚¹æŒ‡é’ˆ
     
    Node(Node<E> prev, E element, Node<E> next) {
    	this.item = element;
     	this.next = next;
     	this.prev = prev;
 	}
}
```

**é‡è¦å±æ€§**å¦‚ä¸‹:

```java
// é“¾è¡¨çš„èŠ‚ç‚¹ä¸ªæ•°
transient int size = 0;
// å¤´èŠ‚ç‚¹æŒ‡é’ˆ
transient Node<E> first;
// å°¾èŠ‚ç‚¹æŒ‡é’ˆ
transient Node<E> last;
```

å¤´å°¾æŒ‡é’ˆéƒ½æ˜¯ **transient** ä¿®é¥°çš„. 

##### 2.æ·»åŠ å…ƒç´ 

å½“å‘æŒ‡å®šèŠ‚ç‚¹å‰æ’å…¥ä¸€ä¸ªèŠ‚ç‚¹æ—¶, å½“å‰èŠ‚ç‚¹çš„**åç»§ä¸ºæŒ‡å®šèŠ‚ç‚¹**, è€Œ**å‰é©±ç»“ç‚¹ä¸ºæŒ‡å®šèŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹**. æ­¤å¤–è¿˜è¦ä¿®æ”¹å‰é©±èŠ‚ç‚¹çš„åç»§ä¸ºå½“å‰èŠ‚ç‚¹, ä»¥åŠåç»§èŠ‚ç‚¹çš„å‰é©±ä¸ºå½“å‰èŠ‚ç‚¹. 

**æœ€æ™®é€š**çš„æ’å…¥å…ƒç´ æ–¹æ³•ä¸º **add()**. 

```java
public boolean add(E e) {
    linkLast(e);
    return true;
}
```

è°ƒç”¨äº† linkLast() æ–¹æ³•, æ‰€ä»¥æœ€åŸºæœ¬çš„ **add()** æ–¹æ³•å…¶å®æ˜¯**å°¾æ’å…¥**çš„. ç”±äºæ˜¯ç»´æŠ¤äº†ä¸€ä¸ª**å°¾æŒ‡é’ˆ**, æ‰€ä»¥å°¾æ’å…¥ä¹Ÿå¾ˆè¿…é€Ÿ. 

```java
void linkLast(E e) {
    // è·å–å½“å‰å°¾ç»“ç‚¹å¼•ç”¨
    final Node<E> l = last;
    // æ„å»ºä¸€ä¸ªprevå€¼ä¸ºl,èŠ‚ç‚¹å€¼ä¸ºe,nextå€¼ä¸ºnullçš„æ–°èŠ‚ç‚¹newNode
    final Node<E> newNode = new Node<>(l, e, null);
    // å°†newNodeä½œä¸ºå°¾èŠ‚ç‚¹
    last = newNode;
    // å¦‚æœåŸå°¾èŠ‚ç‚¹ä¸ºnull, å³åŸé“¾è¡¨ä¸ºnull, åˆ™é“¾è¡¨é¦–èŠ‚ç‚¹ä¹Ÿè®¾ç½®ä¸ºnewNode
    if (l == null)
        first = newNode;
    else    // å¦åˆ™åŸå°¾èŠ‚ç‚¹çš„nextè®¾ç½®ä¸ºnewNode
        l.next = newNode;
    size++;
    modCount++;
}
```

å¯ä»¥åœ¨**æŒ‡å®š**ä½ç½®åŠ å…¥å…ƒç´ : 

```java
public void add(int index, E element) {
    // åˆ¤æ–­ä½ç½®æ˜¯å¦åˆæ³•
    checkPositionIndex(index);
    // å¦‚æœæŒ‡å®šä½ç½®åœ¨å°¾éƒ¨, åˆ™ç›´æ¥é€šè¿‡å°¾æ’æ³•æ¥æ’å…¥æŒ‡å®šå…ƒç´ 
    if (index == size)
        linkLast(element);
    else        // å¦‚æœæŒ‡å®šä½ç½®ä¸æ˜¯å°¾éƒ¨, åˆ™æ·»åŠ åˆ°æŒ‡å®šä½ç½®å‰
        linkBefore(element, node(index));
}
```

**linkBefore()** æ–¹æ³•å¦‚ä¸‹, å³åœ¨**é“¾è¡¨ä¸­é—´**æ’å…¥, åœ¨éç©ºèŠ‚ç‚¹ succ ä¹‹å‰æ’å…¥èŠ‚ç‚¹å€¼ e. ä¸»è¦å°±æ˜¯è¦å„ç§**ä¿®æ”¹æŒ‡é’ˆ**. 

````java
void linkBefore(E e, Node<E> succ) {
    // assert succ != null;
    final Node<E> pred = succ.prev;
    // æ„å»ºä¸€ä¸ªprevå€¼ä¸ºsucc.prev,èŠ‚ç‚¹å€¼ä¸ºe,nextå€¼ä¸ºsuccçš„æ–°èŠ‚ç‚¹newNode
    final Node<E> newNode = new Node<>(pred, e, succ);
    // è®¾ç½®newNodeä¸ºsuccçš„å‰èŠ‚ç‚¹
    succ.prev = newNode;
    // å¦‚æœsucc.prevä¸ºnull, å³å¦‚æœsuccä¸ºé¦–èŠ‚ç‚¹, åˆ™å°†newNodeè®¾ç½®ä¸ºé¦–èŠ‚ç‚¹
    if (pred == null)
        first = newNode;
    else        // å¦‚æœsuccä¸æ˜¯é¦–èŠ‚ç‚¹
        pred.next = newNode;
    size++;
    modCount++;
}
````

çœ‹çœ‹å¸¸ç”¨çš„ API å®ç°. 

```java
public void addFirst(E e) {
    linkFirst(e);
}
```

```java
public boolean offerFirst(E e) {
    addFirst(e);
    return true;
}
```

åœ¨**å¤´éƒ¨**åŠ å…ƒç´ æ—¶æœ€åéƒ½ä¼šè°ƒç”¨**ç§æœ‰æ–¹æ³•** linkFirst(). 

```java
private void linkFirst(E e) {
    final Node<E> f = first;
    final Node<E> newNode = new Node<>(null, e, f);
    first = newNode;
    if (f == null)
        last = newNode;
    else
        f.prev = newNode;
    size++;
    modCount++;
}
```

åœ¨**å°¾éƒ¨**æ·»åŠ æ•°æ®, æœ‰:

```java
public boolean offer(E e) {
    return add(e);
}
```

offer() **é»˜è®¤**è°ƒç”¨ add() æ–¹æ³•. æ­¤å¤–è¿˜æœ‰å¦‚ä¸‹æ–¹æ³•. 

```java
public void addLast(E e) {
    linkLast(e);
}
```

```java
public boolean offerLast(E e) {
    addLast(e);
    return true;
}
```

##### 3.åˆ¤æ–­å­˜åœ¨

**indexOf**(Object o) åˆ¤æ–­é“¾è¡¨ä¸­æ˜¯å¦å­˜åœ¨èŠ‚ç‚¹çš„ element å’Œ o ç›¸ç­‰, è‹¥ç›¸ç­‰åˆ™è¿”å›è¯¥èŠ‚ç‚¹åœ¨é“¾è¡¨ä¸­çš„ç´¢å¼•ä½ç½®, è‹¥ä¸å­˜åœ¨åˆ™è¿”å› -1. 

**contains**(Object o) æ–¹æ³•é€šè¿‡åˆ¤æ–­ indexOf(Object o) çš„è¿”å›å€¼è¿›è¡Œåˆ¤æ–­. 

```java
public boolean contains(Object o) {
     return indexOf(o) != -1;
 }

 public int indexOf(Object o) {
      int index = 0;
      // å½“ä¼ å…¥ä¸ºnull
      if (o == null) {
          for (Entry e = header.next; e != header; e = e.next) {
              if (e.element == null)
                  return index;
              index++;
         }
          // é¡ºåºéå†æ‰¾ç»“ç‚¹
      } else {
         for (Entry e = header.next; e != header; e = e.next) {
             if (o.equals(e.element))
                 return index;
             index++;
        }
    }
     return -1;
 }
```

##### 4.è·å–æ•°æ®

**get(int)** æ–¹æ³•ç”¨äºè·å–**æŒ‡å®šä½ç½®**çš„æ•°æ®. é¦–å…ˆåˆ¤æ–­ä½ç½®ä¿¡æ¯æ˜¯å¦**åˆæ³•**, ç„¶å**éå†**åˆ°å…·ä½“ä½ç½®, è·å¾—èŠ‚ç‚¹çš„ä¸šåŠ¡æ•°æ®(element)å¹¶è¿”å›. 

```java
public E get(int index) {
    // æ£€æŸ¥ç´¢å¼•åˆæ³•æ€§
    checkElementIndex(index);
    // è·å–æŒ‡å®šç´¢å¼•æ•°æ®
    return node(index).item;
}
```

æ³¨æ„: ç”±äºå…·æœ‰**åŒå‘æŒ‡é’ˆ**, æ‰€ä»¥æŸ¥æ‰¾æ—¶ä¼šåˆ¤æ–­å¾…æœç´¢çš„**ç´¢å¼•**ä¸æ•´ä¸ªé“¾è¡¨çš„**é•¿åº¦**å…³ç³», å¦‚æœ**å°äºé“¾è¡¨é•¿åº¦ä¸€åŠ**, é‚£ä¹ˆå°±ä»å¤´éå†, å¦åˆ™ä»å°¾éƒ¨éå†, è¿™æ ·æœ€å¤šä¹Ÿå°±éå†åŠä¸ªé“¾è¡¨é•¿åº¦. å¯ä»¥**æé«˜æŸ¥æ‰¾æ•ˆç‡**. 

```java
Node<E> node(int index) {
    // å¦‚æœæŒ‡å®šä¸‹æ ‡å°äºä¸€åŠå…ƒç´ æ•°é‡, åˆ™ä»é¦–ç»“ç‚¹å¼€å§‹éå†
    if (index < (size >> 1)) {
        Node<E> x = first;
        for (int i = 0; i < index; i++)
            x = x.next;
        return x;
    // å¦åˆ™, ä»å°¾ç»“ç‚¹å¼€å§‹éå†
    } else {
        Node<E> x = last;
        for (int i = size - 1; i > index; i--)
            x = x.prev;
        return x;
    }
}
```

æ³¨æ„: **ä½è¿ç®—**ä¸ç›´æ¥åšé™¤æ³•çš„åŒºåˆ«. å…ˆå°† index ä¸é•¿åº¦ size çš„**ä¸€åŠ**æ¯”è¾ƒ, å¦‚æœ "index < size / 2", å°±åªä»ä½ç½® **0 å¾€å**éå†åˆ°ä½ç½® index å¤„, è€Œå¦‚æœ index > size / 2, å°±åªä»ä½ç½® size å¾€å‰éå†åˆ°ä½ç½® index å¤„. 

##### 5.åˆ é™¤æ•°æ®

**åˆ é™¤**æŒ‡å®šä½ç½®çš„å…ƒç´ ç”¨ remove() æ–¹æ³•. 

```java
public E remove(int index) {
    checkElementIndex(index);
    return unlink(node(index));
}
```

unlink() å®ç°çœŸæ­£çš„åˆ é™¤é€»è¾‘. 

```java
E unlink(Node<E> x) {
    final E element = x.item;
    final Node<E> next = x.next;
    final Node<E> prev = x.prev;
    
    if (prev == null) {
        first = next;
    } else {
        prev.next = next;
        x.prev = null;
    }

    if (next == null) {
        last = prev;
    } else {
        next.prev = prev;
        x.next = null;
    }

    x.item = null;
    size--;
    modCount++;
    return element;
}
```

ä¸ ArrayList æ¯”è¾ƒè€Œè¨€, LinkedList çš„åˆ é™¤åŠ¨ä½œ**ä¸éœ€è¦"ç§»åŠ¨"å¾ˆå¤š**æ•°æ®, ä»è€Œæ•ˆç‡æ›´é«˜. è€Œä¸”åˆ é™¤æ—¶ä¼š**ä¼ å…¥**è¿™ä¸ªç»“ç‚¹, æ‰€ä»¥ä¸ç”¨éå†å»å¯»æ‰¾è¿™ä¸ªç»“ç‚¹, è´¼å¿«. 

#### ä¸ArrayListæ¯”è¾ƒ

- **æ•°æ®ç»“æ„ä¸å®ç°**: ArrayList åŸºäº**åŠ¨æ€æ•°ç»„**å®ç°, LinkedList åŸºäº**åŒå‘é“¾è¡¨**å®ç°.
- **çº¿ç¨‹å®‰å…¨æ€§**: ArrayList å’Œ LinkedList **éƒ½ä¸**ä¿è¯çº¿ç¨‹å®‰å…¨. 
- **å…ƒç´ è®¿é—®**: ArrayList æ”¯æŒå¿«é€Ÿ**éšæœºè®¿é—®**, LinkedList **ä¸æ”¯æŒ**. 
- **å¢åˆ å…ƒç´ æ•ˆç‡**: ArrayList é‡‡ç”¨**æ•°ç»„**å­˜å‚¨, æ’å…¥å…ƒç´ åˆ°æ•°ç»„æœ«å°¾å¤æ‚åº¦ä¸º O(1), ä½†æ˜¯åœ¨æŒ‡å®šä½ç½®æ’å…¥å…ƒç´ ä¸åˆ é™¤å…ƒç´ å¤æ‚åº¦ä¸º O(N). LinkedList é‡‡ç”¨**é“¾è¡¨**å­˜å‚¨, åœ¨åˆ é™¤å…ƒç´ çš„æ—¶å€™ä¸éœ€è¦æŒªåŠ¨åé¢çš„å…ƒç´ , æ“ä½œåŸºæœ¬éƒ½æ˜¯ä¿®æ”¹æŒ‡é’ˆ, LinkedList åœ¨**ä»»æ„ä½ç½®**æ·»åŠ åˆ é™¤å…ƒç´ **æ›´å¿«**.  



#### å‚è€ƒèµ„æ–™

- [ArrayListçº¿ç¨‹å®‰å…¨é—®é¢˜](https://www.cnblogs.com/zhouyuxin/p/11154771.html)







