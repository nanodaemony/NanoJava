[TOC]

#### 开发小结

##### 开发流程

###### 需求理解

- 产品稿多看几遍。完全理解需求，看看有无可以 battle 的点。
- 列出需求列表。
- 某功能是否需要登录。

###### 方案设计

- 填写需求设计Wiki模板。
- 考虑实现方式、测试方式(测试环境+线上环境)，未来可能的拓展。考虑后续内容的新增以及验证方式。

###### 数据库表设计

**字段定义**

- 检查字段给的**长度**够不够用，考虑极端情况。
- 如果字段内容很长，考虑存储到 OSS 中。
- 字段一定要有**默认**值。防止后面查出来出现NPE。INT 和 LONG 型的默认值为 0，存储 JSON 字符串的默认值为 "[]"。
- 每个字段的**注释**一定要写好。是**枚举值**的一定要标明取值信息。
- 字段 dbctime 和 dbutime 一般必须建索引。

**索引与键**

- 确定是否有**唯一键**。如果有业务唯一键就需要定义。
- 如果有唯一索引，需要考虑是否会删除并重建数据，因为是软删除，所以重建数据可能造成唯一索引冲突。
- 仔细检查**索引**。确定区分度大的字段在前面。
- 不要创建重复的索引。

**其他**

- 是否需要**分库分表**。单用户不确定数据量的情况可考虑分表。

###### 接口定义

一定要**仔细完整的定义接口**，否则后期改起来可能会麻烦很多人。

**Swagger**

- 如果接口参数需要**定义枚举值**，则在 Swagger 里面写好。

**方法体**

- 根据接口含义确定 POST/GET/DELETE 方法。**不要混用**。
- 接口加**监控注解**。
- 口算的接口需要包装一层 APIResponse。

**返回值VO**

- 确定整个 VO 以及各个字段的**返回值**能否为 null。不能为 null 的需要进行兜底。
- 服务端内部相关的业务实体类的属性都采用**包装类**，这样可以防止基本类型的默认值影响真实的数据。而返回给端上的**VO都采用基本类型**，保证值不存在的时候也能返回默认值，防止端上解码失败。
- 返回的数据结构中。如果是某个业务的集合，比如关于用户、商品、权益、题目等的信息，考虑单独**抽出对象**表示。
- 如果是多人一同开发，关注一下不同人定义的接口的字段名，风格是否一致。比如相同含义的字段在不同接口叫 studyCount 与 studyCnt。
- 找不到资源时可以抛 404 而不是 null。
- **RPC** 接口考虑数据是否可能会被**默认值**污染。

**其他**

- 涉及**内容**的接口考虑是否需要加密。
- 判断新增的接口是否需要**登录**，是否需要过滤 sign。需要的话进行配置。

###### 开发

写方法时一次写到位，写完**检查几遍**，不要等着后面再看。

**安全性**

- 永远不要相信用户的输入，多做数据校验。
- 多做**防御性**编程，不会有问题。
- 调用 RPC 接口时一定要 **catch 异常**。防止调用失败时产生 500。
- 遇到不确定的接口时，一定要马上进行**测试**。不要到最后发现接口都调用错了。
- 关键地方多打日志，日志一定要把上下文打全。
- 看看是否需要加分布式锁、是否需要事务。
- 需要存储的内容过多考虑存放到 OSS 中。
- 写后读的场景考虑是否有**主从复制延迟**问题。有的话需要强制读主库。
- 对于有问题但未抛出异常的业务是否需要**监控打点**。

**健壮性**

- 考虑字段是否可以**动态配置**以减少发布。比如某个功能开关、日志调试开关等。
- 涉及**权限**的考虑是否需要设置**白名单**。
- 考虑业务是否需要登录。
- MQ 的消息可能会打到不同的机器上，与 MQ 相关的需求尤其需要注意。测试环境的机器与虚环境的机器没有隔离，如果需要打到特定的虚环境，参考：https://confluence.zhenguanyu.com/pages/viewpage.action?pageId=234990989

**规范性**

- 一个需求涉及多个表的，可以起一个需求相关的 Service，对各个数据进行组装。

**其他**

- 开发 Job 尽量不要抛异常，不然会发邮件通知所有人。
- 如果涉及本地缓存的。考虑不同机器之间缓存的值是否一致，不一致则使用 Redis。
- 中文的图片路径需要转码之后发给端上，存到数据库里面的时候就需要进行转码。
- 版本控制：VersionUtil 以及 AdapterChain。
- 开发代码最好别在 master，最好都通过分支来。因为不确定需求的上线顺序或者是否有急切的需求需要上线。

###### 开发完成

**代码优化**

- 及时 **Review**，看看大结构有无问题。
- 看看字段、方法命名是否需要进行优化调整。
- 看看能不能提取更细致的**方法**。
- 提前写 **CheckList**。
- 开发完成后检查一遍数据库索引。根据使用到的方法确定是否需要更新或者增加索引。

**测试**

- 自测所有接口。抓包+数据库验证。
- 跟产品、测试对进度。慢的话则催一催。
- 考虑如何**方便测试**。如有需要提前造好数据。

###### 上线

- **提前**做完上线前的准备工作。SQL 提交、MQ 创建、动态配置等。提 SQL 工单确认两遍！！一定要给其他业务相关人员确认。
- 删掉多余日志。
- 一定要检查仔细本次的代码是否是自己修改的，防止引入 Bug。合 master 与合 online 都是如此。
- online 代码合完之后马上切到 master 分支。
- 比较紧急的情况下可以取消金丝雀。
- 上线前看项目之前的监控。注意与上线后进行对比。
- 上线完成马上告知测试看看。

###### 监控

- 对于内容的情况。考虑能否定时监控内容的存活情况。

##### 问题排查

###### 开发与测试阶段

- 接口 401。未登录。
- 接口 404。看看是不是业务抛的，不是就是 URL 错了。
- 接口 417。没有 sign。看看是不是因为前端接口不需要 sign，还是没有传 sign，还是 sign 过期。
- 接口 500。(1) 虚环境是否正确。(2) 接口路径是否正确。(3) 参数是否正确。(4) 参数值是否正确。(5) 看日志修复。
- 有问题先抓包。

###### 线上

- 首先看日志，评估异常数量。看看是否需要回滚。
- 看上线之前的操作。代码或者配置变更。升级依赖版本也可能造成问题。

##### 其他

- 看源码经验：Debug 断点到某处后，看方法调用栈！！
- 有的资源图片是中文命名的，URL会带上中文，端上如果进行强校验就无法展示，所以涉及到中文的图片存在数据库里面需要进行转码。
- 业务对象如果需要进行一些列的**校验、封装**操作，少些 if-else 的一种方法是可以使用**责任链**模式，类似 AOP 的增强逻辑。(1)可以定义一个校验接口，定义校验规则，可以写一个抽象类，把公共的逻辑封装起来。(2)有多少种校验规则就写几个实现类。(3)如果校验规则有先后顺序或者区分业务线，可以定义一个 Order 接口或枚举。
- 通过 **SQL** 插入数据库数据时会吞掉转义符，如果数据里面就需要 "\\\\" 时，需要在 SQL 里面弄 "\\\\\\\\\"。特别是对象里面的字段又是另一个对象的 JSON 时就会出现。

##### 大佬的话

- Bug 就是 Bug，没有玄学。

